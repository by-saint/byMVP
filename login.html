<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Entrar / Cadastre-se</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:Arial, sans-serif; padding:20px; max-width:600px; margin:0 auto;}
    label{display:block;margin-top:10px}
    input, select {width:100%; padding:8px; margin-top:6px; box-sizing:border-box;}
    .row{display:flex; gap:10px}
    .btn {background:#0b74de; color:white; border:none; padding:10px 14px; border-radius:6px; cursor:pointer}
    .link {background:#eee; border:none; padding:8px 12px; border-radius:6px; cursor:pointer}
    #message{color:green;margin-top:8px}
    #error{color:red;margin-top:8px}
  </style>
</head>
<body>
  <h1>Acesse sua conta</h1>
  <p>Se você acabou de pagar, use o e-mail que você usou no checkout da Kiwify.</p>

  <div id="auth-forms">
    <h2>Cadastrar (novo usuário)</h2>
    <label>Email <input id="su-email" type="email" /></label>
    <label>Senha <input id="su-password" type="password" /></label>
    <label>Escolha seu nicho
      <select id="su-niche">
        <option value="saude">Saúde e Estética</option>
        <option value="estudos">Estudos e Performance</option>
      </select>
    </label>
    <button id="signup" class="btn">Cadastrar e entrar</button>
    <div id="su-msg"></div>

    <hr style="margin:20px 0"/>

    <h2>Já tenho conta</h2>
    <label>Email <input id="in-email" type="email" /></label>
    <label>Senha <input id="in-password" type="password" /></label>
    <button id="login" class="btn">Entrar</button>
    <div id="in-msg"></div>
  </div>

  <p style="margin-top:20px">Se esqueceu a senha, use o link de recuperação (será enviado por e-mail).</p>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    // ====== CONFIGURE AQUI (cole os valores do Supabase) ======
    const SUPABASE_URL = 'https://mrebmxxvljajfgcpsvfv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1yZWJteHZ4bGFqcWZnY3BzdmZ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3Nzk0MjMsImV4cCI6MjA3NTM1NTQyM30.2oxAHxiYph6gvuIwunoypCJexHQbLExULpwqU0UWdDM';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    // =========================================================

    const el = id => document.getElementById(id);

    // Sign up
    el('signup').onclick = async () => {
      el('su-msg').innerText = '';
      const email = el('su-email').value.trim();
      const password = el('su-password').value;
      const niche = el('su-niche').value;
      if(!email || !password) { el('su-msg').innerText = 'Preencha email e senha'; return; }

      // Cria usuário no Supabase
      const { data, error } = await supabase.auth.signUp({ email, password });
      if(error){
        el('su-msg').innerText = 'Erro: ' + error.message;
        return;
      }
      // Se o usuário foi criado, pegamos user id — dependendo da configuração de confirmação por email,
      // data.user pode vir nulo. Para MVP, configure para permitir login direto (ou instrua confirmação por e-mail).
      const user = data.user ?? data?.user ?? null;

      // Caso o supabase não retorne user (email confirmation on), tentaremos entrar automaticamente
      if(!user){
        // tenta login
        const { data: s, error: e2 } = await supabase.auth.signInWithPassword({ email, password });
        if(e2){ el('su-msg').innerText = 'Registro criado. Verifique seu e-mail para confirmar.'; return; }
        user = s.user;
      }

      // Salvar profile (id = user.id)
      try {
        await supabase.from('profiles').upsert({ id: user.id, email, niche });
      } catch (err) {
        console.warn('profile upsert err', err);
      }

      // Redirecionar para página do nicho
      if(niche === 'saude'){
        window.location.href = '/membros-saude.html';
      } else {
        window.location.href = '/membros-estudos.html';
      }
    };

    // Login
    el('login').onclick = async () => {
      el('in-msg').innerText = '';
      const email = el('in-email').value.trim();
      const password = el('in-password').value;
      if(!email || !password) { el('in-msg').innerText = 'Preencha email e senha'; return; }
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if(error){ el('in-msg').innerText = 'Erro: ' + error.message; return; }
      // pega profile para redirecionar
      const user = data.user;
      const { data: profile } = await supabase.from('profiles').select('niche').eq('id', user.id).single();
      const niche = profile?.niche ?? 'estudos';
      if(niche === 'saude') window.location.href='/membros-saude.html';
      else window.location.href='/membros-estudos.html';
    };

    // Mantém usuário logado: se já estiver logado, redireciona automaticamente
    (async function checkSession(){
      const { data } = await supabase.auth.getSession();
      const session = data?.session;
      if(session && session.user){
        // buscar profile
        const { data: profile } = await supabase.from('profiles').select('niche').eq('id', session.user.id).single();
        const niche = profile?.niche ?? 'estudos';
        if(niche === 'saude') window.location.href='/membros-saude.html';
        else window.location.href='/membros-estudos.html';
      }
    })();

  </script>
</body>
</html>
